<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Transform string</title>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
<style id="jsbin-css">
* {
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
  box-sizing: border-box;
  font-size: 18px;
}

textarea {
  display: block;
  width: 100%;
  height: 20vh;
}


li {
  margin: 4px 0;
}

.rule > span:first-child {
  grid-area: 1 / 1 / 2 / 5;
/*   display: block; */
/*   float: left; */
  width: 30%;
}

.delete {
/*   float: left; */
  margin-right: 10px;
}

button {
  cursor: pointer;
}

button:hover {
  background: rgba(1,1,1, 0.1)
}

#rules ol {
  overflow: hidden;
}

.add-rule {
  margin: 20px 0;
  display: block;
  clear: both;
}
</style>
</head>
<body>
  <div id="app">
    <h2>
      Source
    </h2>
  <textarea v-model="source" id="source">1.01	–U2	Pride (In The Name Of Love)
  Producer – Brian Eno, Daniel Lanois
  3:47
  1.02	–The Waterboys	The Whole Of The Moon	4:59
  1.03	–Extreme (2)	Stop The World
  Producer – Nuno Bettencourt
  4:34
  1.04	–Rainbow	Since You've Been Gone
  Producer – Roger Glover
  3:16
  1.05	–Thin Lizzy	Don't Believe A Word
  Producer – John Alcock
  2:18
  1.06	–Free	All Right Now
  Producer – Free, John Kelly (2)
  4:13
  1.07	–Little Angels	Too Much Too Young
  Producer – Andy Julian Paul, Ken Lomas
  4:21
  1.08	–Del Amitri	Kiss This Thing Goodbye
  Producer – Mark Freegard
  4:34
  1.09	–Steppenwolf	Born To Be Wild	3:27
  1.10	–Ugly Kid Joe	Everything About You
  Executive Producer – Bobby Carlton, Dennis Rider
  Producer – Ryan Dorn, Ugly Kid Joe
  4:06
  1.11	–Robert Palmer	Addicted To Love
  Producer – Bernard Edwards
  4:25
  1.12	–Toto	Hold The Line	3:56
  1.13	–Survivor	Eye Of The Tiger	3:47
  1.14	–The Cars	My Best Friend's Girl	3:43
  1.15	–Foreigner	Cold As Ice	3:32
  1.16	–The Black Crowes	Remedy
  Producer – George Drakoulias, The Black Crowes
  5:20
  2.01	–Chris Rea	Let's Dance
  Producer – Chris Rea, Jon Kelly
  4:15
  2.02	–Glenn Frey	The Heat Is On
  Producer – Harold Faltermeyer, Keith Forsey
  3:45
  2.03	–Skid Row	Youth Gone Wild
  Producer – Michael Wagener
  3:19
  2.04	–Alice Cooper (2)	Poison	4:28
  2.05	–Boston	More Than A Feeling	4:41
  2.06	–Texas	I Don't Want A Lover
  Producer – Tim Palmer
  4:22
  2.07	–Golden Earring	Radar Love
  Producer – Golden Earring
  6:23
  2.08	–Jane's Addiction	Been Caught Stealing
  Producer – Dave Jerden, Perry Farrell
  3:22
  2.09	–Gun (2)	Steal Your Fire
  Producer – Kenny McDonald*
  4:14
  2.10	–Manic Street Preachers	Motorcycle Emptiness	4:48
  2.11	–Blue Öyster Cult	(Don't Fear) The Reaper	3:49
  2.12	–Huey Lewis & The News	The Power Of Love
  Producer – Huey Lewis & The News
  3:52
  2.13	–Joe Walsh	Life's Been Good
  Producer – Bill Szymczyk
  4:39
  2.14	–Meat Loaf	Dead Ringer For Love	4:21</textarea>

    <h2>
      Transform rules
    </h2>

    <div id="rules">
      <ol>
        <li v-for="(rule, index) in rules">
          <button class="delete" v-on:click="deleteRule(index)">
            ×
          </button>
          <label class="rule">
            <span>{{ rule.type | labelForRule }}</span>
            <span v-show="rule.value !== null"><input v-model="rule.value" type="text"> ({{ rule.value | display }})
            </span>
            </label>
      </ol>
      
      <div class="add-rule">
        <label><span>Add rule</span>
        <select v-model="newRule">
          <option value="splitter">Splitter</option>
          <option value="ignore">Ignore match</option>
          <option value="strip">Strip match</option>
          <option value="replace">Replacer</option>
          <option value="map">Map to object</option>
          <option value="dropEmpty">Drop empty</option>
        </select>
          </label>
        <button v-on:click="rules.push({ type: newRule, value: newRule === 'dropEmpty' ? null : '' })">
        	Create
      	</button>

      </div>
    </div>

    <h2>
      Result
    </h2>
    <pre>{{ result | json }}</pre>
  </div>
  
  <script type="text/x-template" id="splitter">
  	<li>Split lines by <input v-model="value" type="text"> ({{ value | display }})</li>
  </script>
<!--boot js--><script id="jsbin-javascript" defer>console.clear()
Vue.component('splitter', {
  template: '#splitter',
  props: ['value'],
  filters: {
    display(s) {
      return JSON.stringify(s)
    }
  },
  data: {
    value: '\n'
  }
});

function applyRule(result, rule) {
  return result.reduce((acc, curr) => {
    if (Array.isArray(curr)) {
      if (rule.type === 'dropEmpty' && curr.length === 0) {
       	return acc; 
      }
      
      
      if (rule.type === 'map') {
        const fields = rule.value.split(',').map(_ => _.trim());
        curr = curr.reduce((acc, curr, i) => {
          acc[fields[i]] = curr;
          return acc;
        }, {});
        acc.push(curr);
        return acc;
      }

    	acc.push(applyRule(curr, rule));
      return acc;
    }
    
    if (typeof curr === 'object') {
      if (rule.type === 'dropEmpty' && Object.keys(curr).length === 0) {
       	return acc; 
      }
      
      curr = Object.entries(curr).reduce((acc, [key, value]) => {
        const res = applyRule([value], rule);
        if (res.length) {
        	acc[key] = res[0]
        }
        return acc;
      }, {});
      acc.push(curr);
      return acc;
    }
    
    if (rule.type === 'dropEmpty') {
      if (!curr || (typeof curr === 'string' && !curr.trim())) {
        return acc;
      }
      
      acc.push(curr);
      return acc;
    }
    
    if (rule.type === 'splitter') {
      curr = curr.split(rule.value);
    }
    
    if (rule.type === 'replace') {
      const parts = rule.value.split('/').slice(1, -1);
      curr = curr.replace(new RegExp(parts[0], 'g'), parts[1]);
      acc.push(curr);
      return acc;
    }
    
    if (rule.type === 'strip') {
      let value = rule.value;
      if (value.startsWith('/')) {
				value = rule.value.slice(1, -1);
      }
      
      curr = curr.replace(new RegExp(value, 'g'), "");
      acc.push(curr);
      return acc;
    }

    if (rule.type === 'ignore' && rule.value) {
      if (rule.value.startsWith('/')) {
        let value = rule.value.slice(1, -1);
        if (new RegExp(value).test(curr)) {
          return acc;
        }
      } else {
        if (curr.includes(rule.value)) {
          return acc;
        }
      }
    }
    
    acc.push(curr);
    return acc;
  }, [])
}

const app = new Vue({
  el: '#app',
  filters: {
    display(s) {
      return JSON.stringify(s)
    },
    labelForRule(type) {
      return {
        splitter: 'Split lines by',
        ignore: 'Ignore if matches',
        dropEmpty: 'Drop empty elements',
        strip: 'Strip matching',
        map: 'Map array to object',
        replace: 'Replace /source/with/'
      }[type]
    }
  },
  data: {
    source: document.querySelector('#source').value,
    newRule: 'splitter',
    rules: [
      
    ],
    // result: [],
  },
  computed: {
    result() {
      const rules = this.rules;
      let result = this.source.split('\n');
			// noprotect
      for (let i = 0; i < rules.length; i++) {
        const rule = rules[i];
        result = applyRule(result, rule);
      }

			return result;
	  }
  },
  methods: {
    deleteRule(index) {
      this.rules.splice(index, 1);
    }
  }
})
</script>
</body>
</html>